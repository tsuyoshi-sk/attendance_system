# PWAテスト計画書

**勤怠管理システム v2.0**
**テスト対象:** Progressive Web App (PWA)
**テストフレームワーク:** Playwright + pytest
**計画作成日:** 2025-11-14

---

## 1. テスト目的

iPhone Suica対応勤怠管理PWAの品質保証を目的とし、以下の観点から網羅的にテストを実施する:

1. **Service Worker機能**: オフライン対応、キャッシュ戦略、バックグラウンド同期
2. **SPA動作**: ページ遷移、状態管理、URL制御
3. **UI/UX**: レスポンシブデザイン、アクセシビリティ、ユーザビリティ
4. **PWA仕様準拠**: Manifest、インストール可能性、パフォーマンス

---

## 2. テストスコープ

### 2.1 対象機能

#### ✅ Service Worker
- [x] Service Worker登録・アクティベーション
- [x] キャッシュ戦略（Cache First / Network First）
- [x] オフライン時の動作（オフラインページ表示）
- [x] バックグラウンド同期（sync イベント）
- [x] プッシュ通知
- [x] キャッシュ更新戦略

#### ✅ オフライン機能
- [x] ネットワーク切断時のアプリ動作
- [x] オフライン時のリクエストキューイング
- [x] オンライン復帰時の自動送信
- [x] オフライン状態の視覚的フィードバック

#### ✅ SPA機能
- [x] ページ内遷移（SPAルーティング）
- [x] URLクエリパラメータ処理（?action=punch_in）
- [x] ブラウザ履歴管理（History API）
- [x] 状態管理（UI状態の保持）

#### ✅ UI/UX
- [x] レスポンシブデザイン（モバイル/タブレット/デスクトップ）
- [x] タッチ操作対応
- [x] アクセシビリティ（WCAG 2.1 AA準拠）
- [x] アニメーション・トランジション
- [x] エラーハンドリング表示

#### ✅ PWA仕様
- [x] Web App Manifest検証
- [x] インストール可能性
- [x] セキュリティ（HTTPS要件）
- [x] パフォーマンス（Lighthouse指標）

### 2.2 対象外

- ❌ NFC実機テスト（ハードウェア依存）
- ❌ WebSocket接続テスト（既存テストでカバー済み）
- ❌ バックエンドAPI機能テスト（E2Eテストでカバー済み）

---

## 3. テスト環境

### 3.1 ブラウザ対応

| ブラウザ | バージョン | 対応 |
|---------|----------|------|
| Chrome | 最新版 | ✅ 主要 |
| Firefox | 最新版 | ✅ 主要 |
| Safari | 最新版 | ✅ 主要 |
| Edge | 最新版 | ⚠️ 検証のみ |

### 3.2 デバイス対応

| デバイスタイプ | 画面サイズ | 優先度 |
|-------------|----------|--------|
| iPhone 13/14/15 | 390x844 | 🔴 最重要 |
| iPad | 768x1024 | 🟡 中 |
| Desktop | 1920x1080 | 🟢 低 |

### 3.3 テストデータ

- **ユーザー**: test_admin (管理者権限)
- **従業員**: テスト用従業員データ
- **カード**: テスト用ハッシュデータ

---

## 4. テストケース一覧

### 4.1 Service Workerテスト (test_service_worker.py)

| ID | テスト項目 | 優先度 | 期待結果 |
|----|----------|--------|---------|
| SW-01 | Service Worker登録 | 🔴 | 正常に登録される |
| SW-02 | キャッシュ作成 | 🔴 | 3つのキャッシュ（static/api/image）が作成される |
| SW-03 | 静的アセットキャッシュ | 🔴 | HTMLファイルがキャッシュされる |
| SW-04 | オフラインページ表示 | 🔴 | ネットワーク切断時にoffline.htmlが表示される |
| SW-05 | Cache First戦略 | 🟡 | キャッシュ優先で応答 |
| SW-06 | Network First戦略 | 🟡 | ネットワーク優先で応答 |
| SW-07 | キャッシュ更新 | 🟡 | バックグラウンドで更新される |
| SW-08 | 古いキャッシュ削除 | 🟡 | バージョンアップ時に削除される |

### 4.2 オフライン動作テスト (test_offline_functionality.py)

| ID | テスト項目 | 優先度 | 期待結果 |
|----|----------|--------|---------|
| OFF-01 | オフラインバナー表示 | 🔴 | ネットワーク切断時に表示 |
| OFF-02 | オフライン時の打刻キューイング | 🔴 | リクエストがキューに保存される |
| OFF-03 | オンライン復帰時の自動送信 | 🔴 | キュー内リクエストが送信される |
| OFF-04 | キャッシュからのページロード | 🔴 | オフライン時もページが表示される |
| OFF-05 | API応答のキャッシュ | 🟡 | 過去の応答がキャッシュから返される |

### 4.3 SPAルーティングテスト (test_spa_routing.py)

| ID | テスト項目 | 優先度 | 期待結果 |
|----|----------|--------|---------|
| SPA-01 | 初期ページロード | 🔴 | /pwa/ にアクセスして正常表示 |
| SPA-02 | クエリパラメータ処理 | 🔴 | ?action=punch_in で出勤モード起動 |
| SPA-03 | ブラウザ履歴管理 | 🟡 | 戻る/進むボタンが正常動作 |
| SPA-04 | 状態保持 | 🟡 | ページ遷移後も状態が保持される |
| SPA-05 | ディープリンク | 🟡 | 直接URLアクセスで正しいページ表示 |

### 4.4 UI/UXテスト (test_ui_ux.py)

| ID | テスト項目 | 優先度 | 期待結果 |
|----|----------|--------|---------|
| UI-01 | レスポンシブデザイン（iPhone） | 🔴 | iPhone画面で正常表示 |
| UI-02 | レスポンシブデザイン（iPad） | 🟡 | iPad画面で正常表示 |
| UI-03 | レスポンシブデザイン（Desktop） | 🟢 | Desktop画面で正常表示 |
| UI-04 | タッチ操作 | 🔴 | ボタンタップが反応する |
| UI-05 | キーボード操作 | 🟡 | Tab/Enterで操作可能 |
| UI-06 | エラー表示 | 🔴 | エラーメッセージが適切に表示 |
| UI-07 | 成功通知 | 🔴 | 成功メッセージが表示される |
| UI-08 | ローディング状態 | 🟡 | 処理中にスピナー表示 |
| UI-09 | アニメーション | 🟢 | スムーズなトランジション |

### 4.5 PWA仕様テスト (test_pwa_compliance.py)

| ID | テスト項目 | 優先度 | 期待結果 |
|----|----------|--------|---------|
| PWA-01 | Manifest存在確認 | 🔴 | manifest.jsonが存在 |
| PWA-02 | Manifest内容検証 | 🔴 | 必須フィールドが揃っている |
| PWA-03 | アイコン存在確認 | 🔴 | 必要なサイズのアイコンが存在 |
| PWA-04 | インストール可能性 | 🔴 | インストールプロンプトが表示可能 |
| PWA-05 | スタンドアロンモード | 🟡 | アドレスバーなしで動作 |
| PWA-06 | テーマカラー適用 | 🟡 | #4facfeが適用される |
| PWA-07 | ショートカット機能 | 🟢 | 出勤/退勤ショートカット動作 |

### 4.6 アクセシビリティテスト (test_accessibility.py)

| ID | テスト項目 | 優先度 | 期待結果 |
|----|----------|--------|---------|
| A11Y-01 | コントラスト比 | 🔴 | WCAG AA準拠（4.5:1以上） |
| A11Y-02 | キーボードナビゲーション | 🔴 | すべて操作可能 |
| A11Y-03 | フォーカス表示 | 🔴 | フォーカスが視認可能 |
| A11Y-04 | ARIAラベル | 🟡 | 適切なラベルが設定 |
| A11Y-05 | セマンティックHTML | 🟡 | 意味のあるタグ使用 |

---

## 5. テスト実行計画

### 5.1 実行順序

1. **Phase 1: 基本機能** (必須)
   - Service Worker登録・アクティベーション
   - PWA Manifest検証
   - 基本UIレンダリング

2. **Phase 2: コア機能** (重要)
   - オフライン動作
   - SPAルーティング
   - レスポンシブデザイン

3. **Phase 3: 品質向上** (推奨)
   - アクセシビリティ
   - パフォーマンス
   - アニメーション

### 5.2 実行環境

```bash
# Playwrightインストール
pip install pytest-playwright
playwright install chromium firefox webkit

# テスト実行（全体）
pytest tests/pwa/ -v

# テスト実行（カテゴリ別）
pytest tests/pwa/test_service_worker.py -v
pytest tests/pwa/test_offline_functionality.py -v
pytest tests/pwa/test_spa_routing.py -v
pytest tests/pwa/test_ui_ux.py -v

# HTMLレポート生成
pytest tests/pwa/ --html=pwa_test_report.html --self-contained-html
```

### 5.3 成功基準

| 指標 | 目標値 | 必須/推奨 |
|-----|--------|----------|
| テスト合格率 | 95%以上 | 必須 |
| Service Worker動作率 | 100% | 必須 |
| オフライン機能動作率 | 100% | 必須 |
| アクセシビリティスコア | AA準拠 | 推奨 |
| Lighthouse PWAスコア | 90以上 | 推奨 |

---

## 6. リスクと対策

### 6.1 既知のリスク

| リスク | 影響度 | 対策 |
|-------|--------|------|
| Service Worker登録失敗 | 🔴 高 | HTTPSでテスト実行 |
| ブラウザ互換性問題 | 🟡 中 | 複数ブラウザでテスト |
| NFC機能テスト不可 | 🟡 中 | モック使用 |
| タイミング問題 | 🟢 低 | waitForSelector使用 |

### 6.2 制約事項

- **HTTPS必須**: Service Workerはlocalhost以外ではHTTPS必須
- **ブラウザ依存**: 一部機能はChrome/Safariのみ対応
- **実機NFC**: 実際のNFC読み取りは手動テストが必要

---

## 7. 成果物

### 7.1 テストコード

- `tests/pwa/test_service_worker.py` - Service Worker機能テスト
- `tests/pwa/test_offline_functionality.py` - オフライン動作テスト
- `tests/pwa/test_spa_routing.py` - SPAルーティングテスト
- `tests/pwa/test_ui_ux.py` - UI/UXテスト
- `tests/pwa/test_pwa_compliance.py` - PWA仕様準拠テスト
- `tests/pwa/test_accessibility.py` - アクセシビリティテスト
- `tests/pwa/conftest.py` - 共通フィクスチャ

### 7.2 レポート

- `PWA_TEST_REPORT.md` - 総合テストレポート
- `pwa_test_report.html` - HTMLテストレポート（pytest-html）
- スクリーンショット（エラー時自動保存）

---

## 8. 今後の展開

### 8.1 追加検討項目

- [ ] パフォーマンステスト（Lighthouse CI統合）
- [ ] ビジュアルリグレッションテスト（Percy/Chromatic）
- [ ] モバイル実機テスト（BrowserStack/Sauce Labs）
- [ ] E2Eシナリオテスト拡張

### 8.2 継続的改善

- CI/CDパイプラインへの統合
- テストカバレッジの可視化
- 定期的なテスト実行（nightly build）

---

**承認者:** AI開発チーム
**レビュー日:** 2025-11-14
**次回レビュー:** 機能追加時
